#!/usr/bin/env php
<?php

# Use autoloader through option: --autoload <filePath>
if(($index = array_search("--autoload", $argv)) && ($autoloadFile = @$argv[$index+1]) !== null)
{
    include_once $autoloadFile;
}

# Env var
else if(is_string($autoload = getenv("CLI_AUTOLOAD")))
{
    if(!is_file($autoload))
        throw new LogicException("Autoload file '$autoload' from env APP_AUTOLOAD is not a file");

    require_once $autoload;
}

# Default
else
{
    include_once "./vendor/autoload.php";
}

/**
 * scanFolder
 * 
 * @param string $folder - folder to scan for controllers
 */
function scanFolder(string $folder)
{
    if(!is_dir($folder))
        throw new RuntimeException("Folder '$folder' does not exist");

    foreach(scandir($folder) as $folderItem)
    {
        if($folderItem !== "." && $folderItem !== "..")
        {
            $path = "$folder/$folderItem";

            if(is_file($path) && str_ends_with($path, ".php"))
                include_once $path;
            else if(is_dir($path))
                scanFolder($path);
        }
    }
}

# Scan directories for discovering controllers through option: --scan <folderPath1,folderPath2,...>
if(($index = array_search("--scan-folders", $argv)) && ($scan = @$argv[$index+1]) !== null)
{
    foreach(explode(",", $scan) as $folder)
        scanFolder($folder);
}

use gijsbos\CLIParser\CLIParser\CommandLineParser;
use gijsbos\ApiServer\Utils\RouteParser;
use gijsbos\ApiServer\Utils\RouteTestGenerator;

/**
 * APICLI
 */
final class APICLI
{
    const VERSION = "1.0.0";

    public function printDocs()
    {

    }

    public function process($argv)
    {
        $command = CommandLineParser::parseArgv($argv, 1);

        if($command->isEmpty())
        {
            self::printDocs();
        }
        else
        {
            if(!$command->hasArgs() && ($command->hasFlag("v") || $command->hasOption("--version")))
            {
                printf("\nVersion: %s\n", self::VERSION);
            }
            else
            {
                $arg = $command->getNextArg();

                switch($arg)
                {
                    case "cache":
                        switch($command->getNextArg())
                        {
                            case "routes":
                                RouteParser::run($command);
                            break;
                        }
                    break;

                    case "create":
                        switch($command->getNextArg())
                        {
                            case "tests":
                                RouteTestGenerator::run($command);
                            break;
                        }
                    break;

                    default:
                        self::printDocs();
                }
            }
        }
        echo("\n");
    }
}

try
{
    (new APICLI())->process($argv);
}
catch(\Exception $ex)
{
    echo($ex->getMessage()."\n");
    echo($ex->getTraceAsString()."\n");
}