#!/usr/bin/env php
<?php

# Allow overloading of default autoload e.g. when controllers need to be preloaded
if(is_file("src/autoload.php"))
    include_once "./src/autoload.php";

# Fallback to vendor autoload
else
    include_once "./vendor/autoload.php";

use CommandLineParser\CommandLineParser;
use gijsbos\ApiServer\Utils\RouteParser;

final class APICLI
{
    const VERSION = "1.0.0";

    public function printDocs()
    {

    }

    public function process($argv)
    {
        $command = CommandLineParser::parseArgv($argv, 1);

        if($command->isEmpty())
        {
            self::printDocs();
        }
        else
        {
            if(!$command->hasArgs() && ($command->hasFlag("v") || $command->hasOption("--version")))
            {
                printf("\nVersion: %s\n", self::VERSION);
            }
            else
            {
                $arg = $command->getNextArg();

                switch($arg)
                {
                    case "cache":
                        $verbose = $command->hasFlag("v");
                        $logLevel = $command->getOption("logLevel") ?? "info";

                        switch($command->getNextArg())
                        {
                            case "routes":
                                (new RouteParser())
                                ->setLogLevel(strlen($logLevel) > 0 ? $logLevel : ($verbose ? "info" : ""))
                                ->setLogOutput("console")
                                ->parseControllerFiles();
                            break;
                        }
                    break;

                    default:
                        self::printDocs();
                }
            }
        }
        echo("\n");
    }
}

try
{
    (new APICLI())->process($argv);
}
catch(\Exception $ex)
{
    echo($ex->getMessage()."\n");
    echo($ex->getTraceAsString()."\n");
}